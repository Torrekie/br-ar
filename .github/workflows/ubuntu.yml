name: Build Ubuntu

on:
  push:
    paths:
      - 'VERSION'
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  detect-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - name: Read version from VERSION file
        id: version
        run: |
          if [ -f VERSION ]; then
            VERSION=$(cat VERSION | tr -d '\n\r ')
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Detected version: $VERSION"
          else
            echo "Error: VERSION file not found"
            exit 1
          fi

  build-ubuntu:
    needs: detect-version
    strategy:
      matrix:
        arch: [amd64, arm64]
    runs-on: ubuntu-latest
    container:
      image: ubuntu:20.04
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y autoconf automake make gcc libc6-dev
      - name: Configure and build
        run: |
          autoreconf -fiv
          ./configure --prefix=/usr CFLAGS="-O3" LDFLAGS=""
          make -j$(nproc) || make
      - name: Install
        run: |
          make install DESTDIR=${{ runner.temp }}/install
      - name: Create deb package
        run: |
          apt-get install -y dpkg-dev
          mkdir -p ${{ github.workspace }}/deb/DEBIAN
          echo "Package: br-ar" > ${{ github.workspace }}/deb/DEBIAN/control
          echo "Version: ${{ needs.detect-version.outputs.version }}" >> ${{ github.workspace }}/deb/DEBIAN/control
          echo "Architecture: ${{ matrix.arch }}" >> ${{ github.workspace }}/deb/DEBIAN/control
          echo "Maintainer: Torrekie <me@torrekie.dev>" >> ${{ github.workspace }}/deb/DEBIAN/control
          echo "Description: Bedrock Archive Tool" >> ${{ github.workspace }}/deb/DEBIAN/control
          cp -r ${{ runner.temp }}/install/usr ${{ github.workspace }}/deb/
          DEB_FILE="${{ github.workspace }}/br-ar-${{ needs.detect-version.outputs.version }}-ubuntu-${{ matrix.arch }}.deb"
          dpkg-deb --build ${{ github.workspace }}/deb "$DEB_FILE"
          if [ ! -f "$DEB_FILE" ]; then
            echo "Error: DEB file was not created at $DEB_FILE"
            ls -la ${{ github.workspace }}/
            exit 1
          fi
          echo "DEB file created: $DEB_FILE"
          ls -lh "$DEB_FILE"
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: br-ar-ubuntu-${{ matrix.arch }}
          path: ${{ github.workspace }}/br-ar-${{ needs.detect-version.outputs.version }}-ubuntu-${{ matrix.arch }}.deb

