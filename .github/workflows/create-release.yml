name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (leave empty to read from VERSION file)'
        required: false
        type: string
      trigger_builds:
        description: 'Trigger all build workflows before creating release'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
  push:
    paths:
      - 'VERSION'
    branches:
      - main
      - master

concurrency:
  group: create-release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  detect-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - name: Read version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          elif [ -f VERSION ]; then
            VERSION=$(cat VERSION | tr -d '\n\r ')
          else
            echo "Error: VERSION file not found and no version provided"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

  trigger-builds:
    needs: detect-version
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && (inputs.trigger_builds == 'true' || inputs.trigger_builds == '')
    permissions:
      actions: write
      contents: read
    steps:
      - name: Trigger all build workflows
        run: |
          WORKFLOWS=(
            "windows.yml"
            "macos.yml"
            "linux-glibc.yml"
            "linux-musl.yml"
            "debian.yml"
            "ubuntu.yml"
            "android-termux.yml"
          )
          
          for workflow_file in "${WORKFLOWS[@]}"; do
            echo "Triggering workflow: $workflow_file"
            gh workflow run "$workflow_file" --ref "${{ github.ref_name }}" || \
            echo "Warning: Could not trigger $workflow_file"
          done
          
          echo "All build workflows triggered. Waiting for them to start..."
          sleep 30
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  wait-for-builds:
    needs: [detect-version, trigger-builds]
    runs-on: ubuntu-latest
    if: always() && (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && (inputs.trigger_builds == 'true' || inputs.trigger_builds == '')))
    steps:
      - name: Wait for build workflows to complete
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "Waiting 5 minutes for build workflows to complete (triggered by VERSION change)..."
            sleep 300
          else
            echo "Waiting 10 minutes for manually triggered build workflows to complete..."
            sleep 600
          fi
          echo "Wait complete - proceeding to collect artifacts"

  check-release-exists:
    runs-on: ubuntu-latest
    needs: detect-version
    outputs:
      exists: ${{ steps.check.outputs.exists }}
    steps:
      - name: Check if release already exists
        id: check
        run: |
          VERSION="${{ needs.detect-version.outputs.version }}"
          TAG="v${VERSION}"
          if gh release view "$TAG" &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Release $TAG already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Release $TAG does not exist yet"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  collect-artifacts:
    needs: [detect-version, wait-for-builds, check-release-exists]
    if: needs.check-release-exists.outputs.exists == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: br-ar-*
          merge-multiple: true
          github-token: ${{ secrets.GITHUB_TOKEN }}

  create-release:
    needs: [detect-version, check-release-exists, collect-artifacts]
    if: needs.check-release-exists.outputs.exists == 'false'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: List all collected artifacts
        run: |
          echo "Collected artifacts:"
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.tar.xz" -o -name "*.tar.bz2" \) 2>/dev/null | sort || echo "No artifacts found"
          echo ""
          echo "Artifact count:"
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.tar.xz" -o -name "*.tar.bz2" \) 2>/dev/null | wc -l || echo "0"
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.detect-version.outputs.version }}
          name: Release v${{ needs.detect-version.outputs.version }}
          files: artifacts/**/*
          generate_release_notes: true
          draft: false
          prerelease: false
