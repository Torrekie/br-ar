name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (leave empty to read from VERSION file)'
        required: false
        type: string
      trigger_builds:
        description: 'Trigger all build workflows before creating release'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
  push:
    paths:
      - 'VERSION'
    branches:
      - main
      - master

concurrency:
  group: create-release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  detect-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - name: Read version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          elif [ -f VERSION ]; then
            VERSION=$(cat VERSION | tr -d '\n\r ')
          else
            echo "Error: VERSION file not found and no version provided"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

  trigger-builds:
    needs: detect-version
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && (inputs.trigger_builds == 'true' || inputs.trigger_builds == '')
    permissions:
      actions: write
      contents: read
    steps:
      - name: Debug trigger conditions
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Trigger builds input: ${{ inputs.trigger_builds }}"
          echo "Ref name: ${{ github.ref_name }}"
          echo "Repository: ${{ github.repository }}"
      - name: Trigger all build workflows
        run: |
          WORKFLOWS=(
            "windows.yml"
            "macos.yml"
            "linux-glibc.yml"
            "linux-musl.yml"
            "debian.yml"
            "ubuntu.yml"
            "android-termux.yml"
          )
          
          TRIGGERED=0
          FAILED=0
          
          for workflow_file in "${WORKFLOWS[@]}"; do
            echo ""
            echo "=== Triggering workflow: $workflow_file ==="
            
            # Get workflow ID from file name
            WORKFLOW_ID=$(gh api repos/${{ github.repository }}/actions/workflows/"$workflow_file" --jq '.id' 2>/dev/null || echo "")
            
            if [ -n "$WORKFLOW_ID" ] && [ "$WORKFLOW_ID" != "null" ]; then
              echo "Found workflow ID: $WORKFLOW_ID"
              # Trigger workflow using API
              if gh api repos/${{ github.repository }}/actions/workflows/$WORKFLOW_ID/dispatches \
                --method POST \
                -f ref="${{ github.ref_name }}" 2>&1; then
                echo "✓ Successfully triggered $workflow_file"
                TRIGGERED=$((TRIGGERED + 1))
              else
                echo "✗ Failed to trigger $workflow_file"
                FAILED=$((FAILED + 1))
              fi
            else
              echo "✗ Could not find workflow ID for $workflow_file"
              FAILED=$((FAILED + 1))
            fi
          done
          
          echo ""
          echo "=== Summary ==="
          echo "Successfully triggered: $TRIGGERED workflows"
          echo "Failed: $FAILED workflows"
          echo ""
          echo "Waiting 30 seconds for workflows to start..."
          sleep 30
          echo "You can check the Actions tab to see the triggered workflows."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  wait-for-builds:
    needs: [detect-version, trigger-builds]
    runs-on: ubuntu-latest
    if: |
      always() && 
      (github.event_name == 'push' || 
       (github.event_name == 'workflow_dispatch' && 
        (inputs.trigger_builds == 'true' || inputs.trigger_builds == '')))
    steps:
      - name: Wait for build workflows to complete
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "Waiting 5 minutes for build workflows to complete (triggered by VERSION change)..."
            sleep 300
          else
            echo "Waiting 10 minutes for manually triggered build workflows to complete..."
            echo "Build workflows should be running now. Check the Actions tab to monitor their progress."
            sleep 600
          fi
          echo "Wait complete - proceeding to collect artifacts"

  check-release-exists:
    runs-on: ubuntu-latest
    needs: detect-version
    outputs:
      exists: ${{ steps.check.outputs.exists }}
    steps:
      - name: Check if release already exists
        id: check
        run: |
          VERSION="${{ needs.detect-version.outputs.version }}"
          TAG="v${VERSION}"
          if gh release view "$TAG" &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Release $TAG already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Release $TAG does not exist yet"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  collect-artifacts:
    needs: [detect-version, wait-for-builds, check-release-exists]
    if: needs.check-release-exists.outputs.exists == 'false'
    runs-on: ubuntu-latest
    permissions:
      actions: read
    steps:
      - name: Find and download artifacts from build workflows
        run: |
          VERSION="${{ needs.detect-version.outputs.version }}"
          mkdir -p artifacts
          
          WORKFLOWS=(
            "Build Windows (MSYS2)"
            "Build macOS"
            "Build Linux (glibc)"
            "Build Linux (musl)"
            "Build Debian"
            "Build Ubuntu"
            "Build Android (Termux)"
          )
          
          for workflow_name in "${WORKFLOWS[@]}"; do
            echo "Looking for artifacts from workflow: $workflow_name"
            
            # Get the most recent successful workflow run
            RUN_ID=$(gh run list --workflow="$workflow_name" --branch="${{ github.ref_name }}" --status=success --limit=1 --json databaseId --jq '.[0].databaseId' 2>/dev/null || echo "")
            
            if [ -n "$RUN_ID" ] && [ "$RUN_ID" != "null" ]; then
              echo "Found workflow run ID: $RUN_ID"
              
              # List artifacts from this run
              ARTIFACTS=$(gh api repos/${{ github.repository }}/actions/runs/$RUN_ID/artifacts --jq '.artifacts[] | select(.name | startswith("br-ar-")) | .id' 2>/dev/null || echo "")
              
              if [ -n "$ARTIFACTS" ]; then
                for artifact_id in $ARTIFACTS; do
                  echo "Downloading artifact ID: $artifact_id"
                  gh api repos/${{ github.repository }}/actions/artifacts/$artifact_id/zip --output "artifacts/artifact-$artifact_id.zip" || echo "Failed to download artifact $artifact_id"
                done
              else
                echo "No artifacts found in run $RUN_ID"
              fi
            else
              echo "No successful workflow run found for $workflow_name"
            fi
          done
          
          echo ""
          echo "Extracting downloaded artifacts..."
          cd artifacts
          for zip in *.zip; do
            if [ -f "$zip" ]; then
              unzip -q "$zip" -d "extracted-$zip" || true
              rm "$zip"
            fi
          done
          
          # Move files from extracted directories to artifacts root
          find . -type f \( -name "*.tar.gz" -o -name "*.tar.xz" -o -name "*.tar.bz2" -o -name "*.deb" \) -exec mv {} . \; 2>/dev/null || true
          rm -rf extracted-* || true
          
          echo ""
          echo "Final artifacts:"
          find . -type f \( -name "*.tar.gz" -o -name "*.tar.xz" -o -name "*.tar.bz2" -o -name "*.deb" \) | sort || echo "No artifacts found"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-release:
    needs: [detect-version, check-release-exists, collect-artifacts]
    if: needs.check-release-exists.outputs.exists == 'false'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: List all collected artifacts
        run: |
          echo "Collected artifacts:"
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.tar.xz" -o -name "*.tar.bz2" -o -name "*.deb" \) 2>/dev/null | sort || echo "No artifacts found"
          echo ""
          echo "Artifact count:"
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.tar.xz" -o -name "*.tar.bz2" -o -name "*.deb" \) 2>/dev/null | wc -l || echo "0"
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.detect-version.outputs.version }}
          name: Release v${{ needs.detect-version.outputs.version }}
          files: artifacts/**/*
          generate_release_notes: true
          draft: false
          prerelease: false
