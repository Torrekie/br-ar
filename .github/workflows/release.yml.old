name: Release

on:
  push:
    paths:
      - 'VERSION'
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  detect-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - name: Read version from VERSION file
        id: version
        run: |
          if [ -f VERSION ]; then
            VERSION=$(cat VERSION | tr -d '\n\r ')
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Detected version: $VERSION"
          else
            echo "Error: VERSION file not found"
            exit 1
          fi

  build-windows:
    needs: detect-version
    strategy:
      matrix:
        arch: [x86, x86_64, arm64]
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            autoconf
            automake
            make
            gcc
            mingw-w64-x86_64-gcc
            mingw-w64-i686-gcc
            mingw-w64-ucrt-x86_64-gcc
            clang
      - name: Configure and build (x86_64)
        if: matrix.arch == 'x86_64'
        shell: msys2 {0}
        run: |
          export PATH="/mingw64/bin:$PATH"
          autoreconf -fiv
          ./configure --prefix=/usr CFLAGS="-O3 -march=native" CXXFLAGS="-O3 -march=native"
          make -j$(nproc) || make
      - name: Configure and build (x86)
        if: matrix.arch == 'x86'
        shell: msys2 {0}
        run: |
          export PATH="/mingw32/bin:$PATH"
          autoreconf -fiv
          ./configure --prefix=/usr --host=i686-w64-mingw32 CFLAGS="-O3" CXXFLAGS="-O3"
          make -j$(nproc) || make
      - name: Configure and build (arm64)
        if: matrix.arch == 'arm64'
        shell: msys2 {0}
        run: |
          export PATH="/ucrt64/bin:$PATH"
          autoreconf -fiv
          ./configure --prefix=/usr --host=aarch64-w64-mingw32 CFLAGS="-O3" CXXFLAGS="-O3"
          make -j$(nproc) || make
      - name: Install
        shell: msys2 {0}
        run: |
          INSTALL_DIR="${{ runner.temp }}/install"
          mkdir -p "$INSTALL_DIR"
          make install DESTDIR="$INSTALL_DIR"
      - name: Create tarball
        shell: msys2 {0}
        run: |
          # MSYS2 automatically converts Windows paths
          INSTALL_DIR="${{ runner.temp }}/install"
          OUTPUT_DIR="${{ runner.temp }}"
          OUTPUT_FILE="br-ar-${{ needs.detect-version.outputs.version }}-windows-${{ matrix.arch }}.tar.gz"
          if [ ! -d "$INSTALL_DIR" ]; then
            echo "Error: Install directory does not exist: $INSTALL_DIR"
            ls -la "${{ runner.temp }}" || true
            exit 1
          fi
          if [ ! -d "$INSTALL_DIR/usr" ]; then
            echo "Error: usr directory does not exist in install directory"
            ls -la "$INSTALL_DIR" || true
            exit 1
          fi
          cd "$INSTALL_DIR" || exit 1
          # Create tarball in install directory first, then move to temp
          tar czf "./$OUTPUT_FILE" usr/
          mv "./$OUTPUT_FILE" "$OUTPUT_DIR/$OUTPUT_FILE"
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: br-ar-windows-${{ matrix.arch }}
          path: ${{ runner.temp }}/br-ar-${{ needs.detect-version.outputs.version }}-windows-${{ matrix.arch }}.tar.gz

  build-windows-cygwin:
    needs: detect-version
    strategy:
      matrix:
        arch: [x86, x86_64, arm64]
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false
      - name: Setup Cygwin
        uses: egor-tensin/setup-cygwin@v3
        with:
          packages: autoconf automake make gcc-core gcc-g++ git dos2unix
      - name: Fix line endings
        shell: bash
        run: |
          command -v dos2unix >/dev/null 2>&1 && find . -type f \( -name "*.sh" -o -name "*.in" -o -name "configure.ac" -o -name "Makefile.am" -o -name "*.am" \) -print0 | xargs -0 dos2unix || echo "dos2unix not available, gitattributes should handle line endings"
      - name: Configure and build
        shell: bash
        run: |
          autoreconf -fiv && ./configure --prefix=/usr CFLAGS='-O3' CXXFLAGS='-O3' && make -j$(nproc) || make
      - name: Install
        shell: bash
        run: |
          INSTALL_DIR=$(cygpath -u "${{ runner.temp }}/install" | xargs)
          mkdir -p "$INSTALL_DIR"
          make install DESTDIR="$INSTALL_DIR"
      - name: Create tarball
        shell: bash
        run: |
          INSTALL_DIR=$(cygpath -u "${{ runner.temp }}/install" | xargs)
          OUTPUT_FILE=$(cygpath -u "${{ runner.temp }}/br-ar-${{ needs.detect-version.outputs.version }}-cygwin-${{ matrix.arch }}.tar.gz" | xargs)
          if [ ! -d "$INSTALL_DIR" ]; then
            echo "Error: Install directory does not exist: $INSTALL_DIR"
            TEMP_DIR=$(cygpath -u "${{ runner.temp }}" | xargs)
            ls -la "$TEMP_DIR" || true
            exit 1
          fi
          if [ ! -d "$INSTALL_DIR/usr" ]; then
            echo "Error: usr directory does not exist in install directory"
            ls -la "$INSTALL_DIR" || true
            exit 1
          fi
          cd "$INSTALL_DIR"
          tar czf "$OUTPUT_FILE" usr/
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: br-ar-cygwin-${{ matrix.arch }}
          path: ${{ runner.temp }}/br-ar-${{ needs.detect-version.outputs.version }}-cygwin-${{ matrix.arch }}.tar.gz

  build-linux-glibc:
    needs: detect-version
    strategy:
      matrix:
        arch: [x86_64, arm64]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake make gcc g++ libc6-dev
      - name: Configure and build
        run: |
          autoreconf -fiv
          ./configure --prefix=/usr CFLAGS="-O3 -march=native -static-libgcc" LDFLAGS="-static-libgcc"
          make -j$(nproc) || make
      - name: Install
        run: |
          make install DESTDIR=${{ runner.temp }}/install
      - name: Create tarball
        run: |
          cd ${{ runner.temp }}/install
          tar czf ${{ runner.temp }}/br-ar-${{ needs.detect-version.outputs.version }}-linux-glibc-${{ matrix.arch }}.tar.gz usr/
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: br-ar-linux-glibc-${{ matrix.arch }}
          path: ${{ runner.temp }}/br-ar-${{ needs.detect-version.outputs.version }}-linux-glibc-${{ matrix.arch }}.tar.gz

  build-linux-musl:
    needs: detect-version
    strategy:
      matrix:
        arch: [x86_64, arm64]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install musl toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools autoconf automake make
      - name: Configure and build
        run: |
          autoreconf -fiv
          ./configure --prefix=/usr CC=musl-gcc CFLAGS="-O3 -static" LDFLAGS="-static"
          make -j$(nproc) || make
      - name: Install
        run: |
          make install DESTDIR=${{ runner.temp }}/install
      - name: Create tarball
        run: |
          cd ${{ runner.temp }}/install
          tar czf ${{ runner.temp }}/br-ar-${{ needs.detect-version.outputs.version }}-linux-musl-${{ matrix.arch }}.tar.gz usr/
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: br-ar-linux-musl-${{ matrix.arch }}
          path: ${{ runner.temp }}/br-ar-${{ needs.detect-version.outputs.version }}-linux-musl-${{ matrix.arch }}.tar.gz

  build-android-termux:
    needs: detect-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Android NDK
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r26b-linux.zip
          unzip -q android-ndk-r26b-linux.zip
          echo "ANDROID_NDK_HOME=$PWD/android-ndk-r26b" >> $GITHUB_ENV
          echo "$PWD/android-ndk-r26b/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake make wget unzip
      - name: Configure and build
        run: |
          export PATH=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
          autoreconf -fiv
          # Termux uses uclibc-like environment, build with static linking
          ./configure --prefix=/usr --host=aarch64-linux-android21 CC=aarch64-linux-android21-clang CFLAGS="-O3 -static" LDFLAGS="-static"
          make -j$(nproc) || make
      - name: Install
        run: |
          make install DESTDIR=${{ runner.temp }}/install
      - name: Create deb package
        run: |
          mkdir -p ${{ runner.temp }}/deb/DEBIAN
          echo "Package: br-ar" > ${{ runner.temp }}/deb/DEBIAN/control
          echo "Version: ${{ needs.detect-version.outputs.version }}" >> ${{ runner.temp }}/deb/DEBIAN/control
          echo "Architecture: arm64" >> ${{ runner.temp }}/deb/DEBIAN/control
          echo "Maintainer: Torrekie <me@torrekie.dev>" >> ${{ runner.temp }}/deb/DEBIAN/control
          echo "Description: Bedrock Archive Tool" >> ${{ runner.temp }}/deb/DEBIAN/control
          cp -r ${{ runner.temp }}/install/usr ${{ runner.temp }}/deb/
          dpkg-deb --build ${{ runner.temp }}/deb ${{ runner.temp }}/br-ar-${{ needs.detect-version.outputs.version }}-android-termux-arm64.deb
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: br-ar-android-termux-arm64
          path: ${{ runner.temp }}/br-ar-${{ needs.detect-version.outputs.version }}-android-termux-arm64.deb

  build-macos:
    needs: detect-version
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          brew install autoconf automake
      - name: Build arm64
        run: |
          autoreconf -fiv
          export MACOSX_DEPLOYMENT_TARGET=11.0
          export CC="clang -target arm64-apple-darwin11.0"
          export CXX="clang++ -target arm64-apple-darwin11.0"
          ./configure --prefix=/usr/local CFLAGS="-O3" CXXFLAGS="-O3"
          make -j$(sysctl -n hw.ncpu) || make
          make install DESTDIR=${{ runner.temp }}/install-arm64
      - name: Build x86_64
        run: |
          autoreconf -fiv
          export MACOSX_DEPLOYMENT_TARGET=10.10
          # Clean any previous build
          make clean || true
          # Use arch flag to force x86_64 build on arm64 runners
          arch -x86_64 bash -c '
            export CC="clang -target x86_64-apple-darwin10.10"
            export CXX="clang++ -target x86_64-apple-darwin10.10"
            ./configure --prefix=/usr/local CFLAGS="-O3" CXXFLAGS="-O3"
            make clean || true
            make -j$(sysctl -n hw.ncpu) || make
            # Verify the binary is actually x86_64
            file src/br_ar | grep -q "x86_64" || { echo "ERROR: Binary is not x86_64"; file src/br_ar; exit 1; }
            make install DESTDIR=${{ runner.temp }}/install-x86_64
          ' || {
            # Fallback: try without arch if not available
            make clean || true
            export CC="clang -target x86_64-apple-darwin10.10 -arch x86_64"
            export CXX="clang++ -target x86_64-apple-darwin10.10 -arch x86_64"
            ./configure --prefix=/usr/local CFLAGS="-O3 -arch x86_64" CXXFLAGS="-O3 -arch x86_64"
            make -j$(sysctl -n hw.ncpu) || make
            # Verify the binary is actually x86_64
            file src/br_ar | grep -q "x86_64" || { echo "ERROR: Binary is not x86_64"; file src/br_ar; exit 1; }
            make install DESTDIR=${{ runner.temp }}/install-x86_64
          }
      - name: Create universal binaries
        run: |
          mkdir -p ${{ runner.temp }}/install/usr/local
          # Copy all files from arm64 build first
          cp -r ${{ runner.temp }}/install-arm64/usr/local/* ${{ runner.temp }}/install/usr/local/ 2>/dev/null || true
          # Find br_ar binary and create universal br-ar
          arm64_binary="${{ runner.temp }}/install-arm64/usr/local/bin/br_ar"
          x86_64_binary="${{ runner.temp }}/install-x86_64/usr/local/bin/br_ar"
          output_binary="${{ runner.temp }}/install/usr/local/bin/br-ar"
          if [ -f "$arm64_binary" ] && [ -f "$x86_64_binary" ]; then
            # Verify architectures
            arm64_arch=$(file "$arm64_binary" | grep -o "arm64" || echo "")
            x86_64_arch=$(file "$x86_64_binary" | grep -o "x86_64" || echo "")
            echo "arm64_binary: $(file "$arm64_binary")"
            echo "x86_64_binary: $(file "$x86_64_binary")"
            if [ -n "$arm64_arch" ] && [ -n "$x86_64_arch" ]; then
              mkdir -p "$(dirname "$output_binary")"
              lipo -create "$arm64_binary" "$x86_64_binary" -output "$output_binary"
              echo "Created universal binary: $output_binary"
            else
              echo "ERROR: Architectures don't match - cannot create universal binary"
              exit 1
            fi
          fi
          # Handle any other Mach-O binaries
          find ${{ runner.temp }}/install-arm64/usr/local -type f | while read arm64_file; do
            if file "$arm64_file" | grep -q "Mach-O" && [ "$(basename "$arm64_file")" != "br_ar" ]; then
              rel_path=$(echo "$arm64_file" | sed "s|${{ runner.temp }}/install-arm64/usr/local/||")
              x86_64_file="${{ runner.temp }}/install-x86_64/usr/local/$rel_path"
              output_file="${{ runner.temp }}/install/usr/local/$rel_path"
              if [ -f "$x86_64_file" ] && file "$x86_64_file" | grep -q "Mach-O"; then
                mkdir -p "$(dirname "$output_file")"
                lipo -create "$arm64_file" "$x86_64_file" -output "$output_file" 2>/dev/null || cp "$arm64_file" "$output_file"
              fi
            fi
          done
      - name: Code sign
        run: |
          find ${{ runner.temp }}/install -type f | while read file; do
            if file "$file" | grep -q "Mach-O"; then
              codesign -f -s - "$file" || true
            fi
          done
      - name: Create tarball
        run: |
          cd ${{ runner.temp }}/install
          tar czf ${{ runner.temp }}/br-ar-${{ needs.detect-version.outputs.version }}-macos-universal.tar.gz usr/
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: br-ar-macos-universal
          path: ${{ runner.temp }}/br-ar-${{ needs.detect-version.outputs.version }}-macos-universal.tar.gz

  build-macos-pkg:
    needs: detect-version
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          brew install autoconf automake
      - name: Build arm64
        run: |
          autoreconf -fiv
          export MACOSX_DEPLOYMENT_TARGET=11.0
          export CC="clang -target arm64-apple-darwin11.0"
          export CXX="clang++ -target arm64-apple-darwin11.0"
          ./configure --prefix=/usr/local CFLAGS="-O3" CXXFLAGS="-O3"
          make -j$(sysctl -n hw.ncpu) || make
          make install DESTDIR=${{ runner.temp }}/install-arm64
      - name: Build x86_64
        run: |
          autoreconf -fiv
          export MACOSX_DEPLOYMENT_TARGET=10.10
          # Clean any previous build
          make clean || true
          # Use arch flag to force x86_64 build on arm64 runners
          arch -x86_64 bash -c '
            export CC="clang -target x86_64-apple-darwin10.10"
            export CXX="clang++ -target x86_64-apple-darwin10.10"
            ./configure --prefix=/usr/local CFLAGS="-O3" CXXFLAGS="-O3"
            make clean || true
            make -j$(sysctl -n hw.ncpu) || make
            # Verify the binary is actually x86_64
            file src/br_ar | grep -q "x86_64" || { echo "ERROR: Binary is not x86_64"; file src/br_ar; exit 1; }
            make install DESTDIR=${{ runner.temp }}/install-x86_64
          ' || {
            # Fallback: try without arch if not available
            make clean || true
            export CC="clang -target x86_64-apple-darwin10.10 -arch x86_64"
            export CXX="clang++ -target x86_64-apple-darwin10.10 -arch x86_64"
            ./configure --prefix=/usr/local CFLAGS="-O3 -arch x86_64" CXXFLAGS="-O3 -arch x86_64"
            make -j$(sysctl -n hw.ncpu) || make
            # Verify the binary is actually x86_64
            file src/br_ar | grep -q "x86_64" || { echo "ERROR: Binary is not x86_64"; file src/br_ar; exit 1; }
            make install DESTDIR=${{ runner.temp }}/install-x86_64
          }
      - name: Create universal binaries
        run: |
          mkdir -p ${{ runner.temp }}/install/usr/local
          # Copy all files from arm64 build first
          cp -r ${{ runner.temp }}/install-arm64/usr/local/* ${{ runner.temp }}/install/usr/local/ 2>/dev/null || true
          # Find br_ar binary and create universal br-ar
          arm64_binary="${{ runner.temp }}/install-arm64/usr/local/bin/br_ar"
          x86_64_binary="${{ runner.temp }}/install-x86_64/usr/local/bin/br_ar"
          output_binary="${{ runner.temp }}/install/usr/local/bin/br-ar"
          if [ -f "$arm64_binary" ] && [ -f "$x86_64_binary" ]; then
            # Verify architectures
            arm64_arch=$(file "$arm64_binary" | grep -o "arm64" || echo "")
            x86_64_arch=$(file "$x86_64_binary" | grep -o "x86_64" || echo "")
            echo "arm64_binary: $(file "$arm64_binary")"
            echo "x86_64_binary: $(file "$x86_64_binary")"
            if [ -n "$arm64_arch" ] && [ -n "$x86_64_arch" ]; then
              mkdir -p "$(dirname "$output_binary")"
              lipo -create "$arm64_binary" "$x86_64_binary" -output "$output_binary"
              echo "Created universal binary: $output_binary"
            else
              echo "ERROR: Architectures don't match - cannot create universal binary"
              exit 1
            fi
          fi
          # Handle any other Mach-O binaries
          find ${{ runner.temp }}/install-arm64/usr/local -type f | while read arm64_file; do
            if file "$arm64_file" | grep -q "Mach-O" && [ "$(basename "$arm64_file")" != "br_ar" ]; then
              rel_path=$(echo "$arm64_file" | sed "s|${{ runner.temp }}/install-arm64/usr/local/||")
              x86_64_file="${{ runner.temp }}/install-x86_64/usr/local/$rel_path"
              output_file="${{ runner.temp }}/install/usr/local/$rel_path"
              if [ -f "$x86_64_file" ] && file "$x86_64_file" | grep -q "Mach-O"; then
                mkdir -p "$(dirname "$output_file")"
                lipo -create "$arm64_file" "$x86_64_file" -output "$output_file" 2>/dev/null || cp "$arm64_file" "$output_file"
              fi
            fi
          done
      - name: Code sign
        run: |
          find ${{ runner.temp }}/install -type f | while read file; do
            if file "$file" | grep -q "Mach-O"; then
              codesign -f -s - "$file" || true
            fi
          done
      - name: Create pkg installer
        run: |
          pkgbuild --root ${{ runner.temp }}/install \
            --identifier dev.torrekie.br-ar \
            --version ${{ needs.detect-version.outputs.version }} \
            --install-location / \
            ${{ runner.temp }}/br-ar-${{ needs.detect-version.outputs.version }}-macos-universal.pkg
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: br-ar-macos-pkg-universal
          path: ${{ runner.temp }}/br-ar-${{ needs.detect-version.outputs.version }}-macos-universal.pkg

  build-debian:
    needs: detect-version
    strategy:
      matrix:
        arch: [amd64, arm64]
    runs-on: ubuntu-latest
    container:
      image: debian:oldstable-slim
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y autoconf automake make gcc libc6-dev
      - name: Configure and build
        run: |
          autoreconf -fiv
          ./configure --prefix=/usr CFLAGS="-O3" LDFLAGS=""
          make -j$(nproc) || make
      - name: Install
        run: |
          make install DESTDIR=${{ runner.temp }}/install
      - name: Create deb package
        run: |
          mkdir -p ${{ runner.temp }}/deb/DEBIAN
          echo "Package: br-ar" > ${{ runner.temp }}/deb/DEBIAN/control
          echo "Version: ${{ needs.detect-version.outputs.version }}" >> ${{ runner.temp }}/deb/DEBIAN/control
          echo "Architecture: ${{ matrix.arch }}" >> ${{ runner.temp }}/deb/DEBIAN/control
          echo "Maintainer: Torrekie <me@torrekie.dev>" >> ${{ runner.temp }}/deb/DEBIAN/control
          echo "Description: Bedrock Archive Tool" >> ${{ runner.temp }}/deb/DEBIAN/control
          cp -r ${{ runner.temp }}/install/usr ${{ runner.temp }}/deb/
          dpkg-deb --build ${{ runner.temp }}/deb ${{ runner.temp }}/br-ar-${{ needs.detect-version.outputs.version }}-debian-${{ matrix.arch }}.deb
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: br-ar-debian-${{ matrix.arch }}
          path: ${{ runner.temp }}/br-ar-${{ needs.detect-version.outputs.version }}-debian-${{ matrix.arch }}.deb

  build-ubuntu:
    needs: detect-version
    strategy:
      matrix:
        arch: [amd64, arm64]
    runs-on: ubuntu-latest
    container:
      image: ubuntu:20.04
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y autoconf automake make gcc libc6-dev
      - name: Configure and build
        run: |
          autoreconf -fiv
          ./configure --prefix=/usr CFLAGS="-O3" LDFLAGS=""
          make -j$(nproc) || make
      - name: Install
        run: |
          make install DESTDIR=${{ runner.temp }}/install
      - name: Create deb package
        run: |
          mkdir -p ${{ runner.temp }}/deb/DEBIAN
          echo "Package: br-ar" > ${{ runner.temp }}/deb/DEBIAN/control
          echo "Version: ${{ needs.detect-version.outputs.version }}" >> ${{ runner.temp }}/deb/DEBIAN/control
          echo "Architecture: ${{ matrix.arch }}" >> ${{ runner.temp }}/deb/DEBIAN/control
          echo "Maintainer: Torrekie <me@torrekie.dev>" >> ${{ runner.temp }}/deb/DEBIAN/control
          echo "Description: Bedrock Archive Tool" >> ${{ runner.temp }}/deb/DEBIAN/control
          cp -r ${{ runner.temp }}/install/usr ${{ runner.temp }}/deb/
          dpkg-deb --build ${{ runner.temp }}/deb ${{ runner.temp }}/br-ar-${{ needs.detect-version.outputs.version }}-ubuntu-${{ matrix.arch }}.deb
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: br-ar-ubuntu-${{ matrix.arch }}
          path: ${{ runner.temp }}/br-ar-${{ needs.detect-version.outputs.version }}-ubuntu-${{ matrix.arch }}.deb

  create-release:
    needs: [detect-version, build-windows, build-windows-cygwin, build-linux-glibc, build-linux-musl, build-android-termux, build-macos, build-macos-pkg, build-debian, build-ubuntu]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.detect-version.outputs.version }}
          name: Release v${{ needs.detect-version.outputs.version }}
          files: artifacts/**/*
          generate_release_notes: true
          draft: false
          prerelease: false

